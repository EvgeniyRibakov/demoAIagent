# 🚀 Стратегия разработки версии 2.0

**Дата:** 15 октября 2025  
**Цель:** Полностью автоматизировать работу менеджеров с адаптивной структурой

---

## 🎯 Главная идея v2.0

**Простой запуск менеджером без знания кода:**
1. Менеджер открывает таблицу
2. Нажимает кнопку "Запустить анализ"
3. Скрипт автоматически:
   - Находит данные (вчера vs сегодня)
   - Определяет структуру таблицы (адаптивно)
   - Сверяет с алгоритмами
   - Выдает конкретные рекомендации
4. Менеджер получает готовый план действий

---

## 🤔 Python vs Google Apps Script?

### ✅ РЕКОМЕНДАЦИЯ: **Google Apps Script как основа**

**Почему Apps Script лучше для v2.0:**

1. **Простота запуска для менеджера**
   - Кнопка прямо в таблице
   - Не нужно устанавливать Python
   - Работает на любом устройстве (ПК, планшет, телефон)
   - Не зависит от локального компьютера

2. **Быстрый доступ к данным**
   - Прямая работа с ячейками
   - Нет задержек на API запросы
   - Мгновенная подсветка результатов

3. **Визуализация в таблице**
   - Подсветка проблемных ячеек
   - Комментарии с рекомендациями
   - Всплывающие окна с результатами
   - Боковая панель для управления

4. **Простота обновления**
   - Обновил код → сразу работает
   - Не нужно деплоить
   - Версионирование встроенное

### 🐍 Когда использовать Python:

1. **Сложная аналитика**
   - ML/AI прогнозирование
   - Большие вычисления
   - Работа с внешними API

2. **Интеграции**
   - tl;dv анализ созвонов
   - Маркетплейсы API
   - Рекламные системы

3. **Отчетность**
   - PDF отчеты
   - Email рассылки
   - Git автоматизация

---

## 🏗️ Архитектура версии 2.0

### Основа: Google Apps Script (80% функционала)

```
Google Sheets
    ↓
Кнопка "Запустить анализ"
    ↓
Apps Script (адаптивный анализатор)
    ↓
┌─────────────────────────────────────┐
│ 1. Автоопределение структуры        │
│    - Найти колонки дат              │
│    - Найти названия метрик          │
│    - Адаптироваться к изменениям    │
│                                     │
│ 2. Сбор данных                      │
│    - Вчера vs Сегодня              │
│    - Вычисление изменений          │
│                                     │
│ 3. Применение алгоритмов           │
│    - Чтение листа "Алгоритм"       │
│    - Сопоставление с правилами     │
│                                     │
│ 4. Генерация рекомендаций          │
│    - Конкретные действия           │
│    - Приоритизация                 │
│                                     │
│ 5. Визуализация                    │
│    - Подсветка в таблице           │
│    - Всплывающее окно с планом     │
│    - Боковая панель для деталей    │
└─────────────────────────────────────┘
    ↓
Менеджер видит готовый план действий
```

### Дополнение: Python (20% функционала)

```
Python микросервисы (опционально)
    ↓
┌─────────────────────────────────────┐
│ 1. Анализ созвонов (tl;dv)         │
│    - Извлечение инсайтов           │
│    - Обновление алгоритмов         │
│                                     │
│ 2. Прогнозирование (ML)            │
│    - Тренды на неделю              │
│    - Рекомендации превентивные     │
│                                     │
│ 3. Внешние интеграции              │
│    - API маркетплейсов             │
│    - Рекламные системы             │
└─────────────────────────────────────┘
```

---

## 🔄 Адаптивность к изменениям структуры

### Проблема:
Столбец "CTR" переместился или переименован → скрипт ломается

### Решение: Умное определение структуры

#### 1. **Поиск по ключевым словам (не по позиции)**

```javascript
// ❌ Плохо (жесткая привязка к позиции)
const ctrValue = sheet.getRange(row, 5).getValue();

// ✅ Хорошо (поиск по названию)
function findColumn(sheet, keywords) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  for (let i = 0; i < headers.length; i++) {
    const header = String(headers[i]).toLowerCase().trim();
    
    // Проверяем совпадение с любым из ключевых слов
    for (const keyword of keywords) {
      if (header.includes(keyword.toLowerCase())) {
        return i + 1; // Возвращаем номер колонки
      }
    }
  }
  
  return null; // Не найдено
}

// Использование
const ctrCol = findColumn(sheet, ['ctr', 'click-through', 'кликабельность']);
if (ctrCol) {
  const ctrValue = sheet.getRange(row, ctrCol).getValue();
}
```

#### 2. **Автоматическое определение типа данных**

```javascript
function detectColumnType(sheet, colIndex) {
  const values = sheet.getRange(2, colIndex, 10, 1).getValues(); // 10 строк для анализа
  
  let hasPercent = false;
  let hasNumbers = false;
  let hasDates = false;
  
  for (const [value] of values) {
    const str = String(value);
    
    if (str.includes('%')) hasPercent = true;
    if (!isNaN(parseFloat(str))) hasNumbers = true;
    if (str.match(/\d{1,2}\.\d{1,2}\.\d{2,4}/)) hasDates = true;
  }
  
  if (hasDates) return 'date';
  if (hasPercent) return 'percentage';
  if (hasNumbers) return 'number';
  
  return 'text';
}
```

#### 3. **Гибкое сопоставление метрик с алгоритмами**

```javascript
function matchMetricToRule(metricName, rules) {
  const metricLower = metricName.toLowerCase().trim();
  
  // Точное совпадение
  for (const rule of rules) {
    if (rule.Metric.toLowerCase().trim() === metricLower) {
      return rule;
    }
  }
  
  // Частичное совпадение (по ключевым словам)
  for (const rule of rules) {
    const ruleKeywords = rule.Metric.toLowerCase().split(/[\s,]+/);
    
    for (const keyword of ruleKeywords) {
      if (keyword.length > 3 && metricLower.includes(keyword)) {
        return rule;
      }
    }
  }
  
  return null; // Правило не найдено
}
```

#### 4. **Самообучение структуры**

```javascript
// Сохраняем найденную структуру для ускорения
const CACHE = {
  lastUpdate: null,
  structure: null
};

function getTableStructure(sheet, forceRefresh = false) {
  // Используем кэш если структура не изменилась
  if (!forceRefresh && CACHE.structure && 
      (Date.now() - CACHE.lastUpdate) < 3600000) { // 1 час
    return CACHE.structure;
  }
  
  // Определяем структуру заново
  const structure = {
    dateColumns: findDateColumns(sheet),
    metricColumns: findMetricColumns(sheet),
    dataStartRow: findDataStartRow(sheet)
  };
  
  CACHE.structure = structure;
  CACHE.lastUpdate = Date.now();
  
  return structure;
}
```

---

## 📋 План разработки v2.0

### Фаза 1: Адаптивная база (2-3 дня)

**Цель:** Создать умный анализатор который сам определяет структуру

**Задачи:**
1. ✅ Функция автопоиска колонок по ключевым словам
2. ✅ Функция определения типа данных
3. ✅ Функция поиска дат (вчера/сегодня)
4. ✅ Гибкое сопоставление метрик с алгоритмами
5. ✅ Кэширование структуры

**Результат:**
Скрипт работает даже если переименовали или переместили колонки

### Фаза 2: Улучшенные алгоритмы (2-3 дня)

**Цель:** Детальные рекомендации на основе правил

**Задачи:**
1. ✅ Расширенный формат правил в "Алгоритм"
2. ✅ Приоритизация рекомендаций
3. ✅ Пошаговые инструкции для менеджера
4. ✅ Проверка зависимостей между метриками

**Пример улучшенного правила:**

```
Правило R001: "Если CR упал на 15%"

Тогда проверить:
1. Цену конкурентов (возможно подняли/опустили)
   → Действие: Скорректировать цену на ±5%
   
2. CTR (если тоже упал)
   → Действие: Обновить главное фото
   
3. Показы (если упали)
   → Действие: Увеличить ставку на 10%
   
4. Если ничего не помогло
   → Действие: Создать тикет на контент-команду

Приоритет: Высокий
Автоприменение: Нет (требует одобрения)
```

### Фаза 3: UX для менеджера (1-2 дня)

**Цель:** Максимально простой интерфейс

**Задачи:**
1. ✅ Большая кнопка "Запустить анализ"
2. ✅ Всплывающее окно с результатами
3. ✅ Чеклист действий (можно отмечать)
4. ✅ Прогресс-бар выполнения

**Интерфейс:**

```
┌─────────────────────────────────────────┐
│  📊 Анализ завершен!                    │
├─────────────────────────────────────────┤
│                                         │
│  Найдено проблем: 5                     │
│  Критичных: 2                          │
│  Важных: 3                             │
│                                         │
│  🔴 СРОЧНО (требуют действий сегодня):  │
│  ☐ CR упал на 23% → Проверить цены     │
│  ☐ Показы упали на 40% → Поднять ставки│
│                                         │
│  🟡 ВАЖНО (требуют внимания):           │
│  ☐ CTR упал на 18% → Обновить фото     │
│  ☐ Клики упали на 15% → Проверить текст│
│  ☐ Корзина -12% → Проанализировать отзывы│
│                                         │
│  [Детали]  [Экспорт]  [Закрыть]       │
└─────────────────────────────────────────┘
```

### Фаза 4: Интеграции (опционально, 3-5 дней)

**Цель:** Автоматическое применение действий

**Задачи:**
1. API Wildberries/Ozon для цен
2. API Яндекс.Директ для ставок
3. Создание тикетов в Notion/Jira
4. Telegram уведомления

**Архитектура:**

```
Google Apps Script (основа)
    ↓
Webhook → Python микросервис
    ↓
API маркетплейсов / рекламных систем
    ↓
Результат → обратно в Google Sheets
```

---

## 🎨 Пример финального workflow v2.0

### Утро менеджера:

**9:00** - Открыл таблицу
```
Видит красную иконку: "Найдено 5 проблем"
```

**9:01** - Нажал кнопку "Запустить анализ"
```
Прогресс-бар: Анализируем данные... 50%
```

**9:02** - Получил результаты
```
┌─────────────────────────────────────────┐
│  🔴 КРИТИЧНО:                           │
│                                         │
│  CR упал на 23% (товар XYZ)            │
│                                         │
│  Анализ показал:                       │
│  ✓ Цена конкурентов: -15% (они снизили)│
│  ✓ CTR: в норме                        │
│  ✓ Показы: в норме                     │
│                                         │
│  📋 Рекомендуемые действия:            │
│  1. Снизить цену на 10-15%             │
│  2. Следить за конкурентами           │
│  3. Если не поможет за 2 дня →        │
│     создать тикет на контент          │
│                                         │
│  [Применить цену -12%]  [Отложить]    │
└─────────────────────────────────────────┘
```

**9:03** - Нажал "Применить цену -12%"
```
✅ Цена обновлена в системе
✅ Записано в историю изменений
✅ Уведомление отправлено в Telegram
```

**9:05** - Продолжил работу, зная что все под контролем

---

## 🛠️ Технический стек v2.0

### Основа (обязательно):
- ✅ Google Apps Script
- ✅ Google Sheets
- ✅ JavaScript ES6+

### Дополнения (опционально):
- 🐍 Python 3.9+ (для сложных интеграций)
- 📊 Pandas (для аналитики)
- 🤖 OpenAI API (для анализа созвонов)
- 📱 Telegram Bot (для уведомлений)

---

## 📊 Сравнение подходов

| Критерий | Apps Script | Python |
|----------|-------------|--------|
| **Простота запуска** | ⭐⭐⭐⭐⭐ (кнопка в таблице) | ⭐⭐ (нужен терминал) |
| **Доступность** | ⭐⭐⭐⭐⭐ (любое устройство) | ⭐⭐ (нужен Python) |
| **Скорость работы с Sheets** | ⭐⭐⭐⭐⭐ (прямой доступ) | ⭐⭐⭐ (через API) |
| **Сложная логика** | ⭐⭐⭐ (хватает для v2.0) | ⭐⭐⭐⭐⭐ (любая сложность) |
| **Интеграции** | ⭐⭐⭐ (есть UrlFetchApp) | ⭐⭐⭐⭐⭐ (любые библиотеки) |
| **ML/AI** | ⭐⭐ (ограничено) | ⭐⭐⭐⭐⭐ (любые модели) |
| **Визуализация** | ⭐⭐⭐⭐⭐ (в таблице) | ⭐⭐⭐ (отдельные отчеты) |
| **Обновление** | ⭐⭐⭐⭐⭐ (мгновенно) | ⭐⭐⭐ (нужен деплой) |

### ✅ Вывод: Apps Script для v2.0

**Основной функционал на Apps Script**, Python только для:
- Анализа созвонов (tl;dv)
- Сложных ML прогнозов
- Интеграций с внешними API

---

## 🎯 Приоритеты разработки v2.0

### Высокий приоритет (делаем сразу):
1. ✅ Адаптивное определение структуры
2. ✅ Автопоиск дат (вчера/сегодня)
3. ✅ Гибкое сопоставление с алгоритмами
4. ✅ Детальные рекомендации
5. ✅ Простая кнопка запуска

### Средний приоритет (через неделю):
1. Telegram уведомления
2. Прогресс-бар
3. История изменений
4. Экспорт результатов

### Низкий приоритет (будущее):
1. API интеграции
2. ML прогнозирование
3. Анализ созвонов
4. Автоприменение действий

---

## 📝 Следующие шаги

### Шаг 1: Создаем адаптивный анализатор (Apps Script)
```javascript
// src/apps-script/adaptive-analyzer-v2.gs
// Умный анализатор который сам определяет структуру
```

### Шаг 2: Тестируем на разных структурах
- Переименовываем колонки
- Меняем порядок
- Проверяем что все работает

### Шаг 3: Добавляем UX для менеджера
- Большая кнопка
- Всплывающие окна
- Чеклист действий

### Шаг 4: Пилот с реальным менеджером
- Даем попробовать
- Собираем фидбек
- Улучшаем

---

## 🎉 Итого

**Версия 2.0 = Apps Script (основа) + Python (опционально)**

**Главное:**
- ✅ Менеджер запускает одной кнопкой
- ✅ Скрипт сам определяет структуру
- ✅ Адаптируется к изменениям
- ✅ Выдает конкретные действия
- ✅ Экономит 90% времени менеджера

**Начинаем с Фазы 1: Адаптивная база на Apps Script!** 🚀

---

**Версия:** 2.0 (план)  
**Дата:** 2025-10-15  
**Основа:** Google Apps Script  
**Цель:** Полная автономия для менеджера

