# AI-агент для автоматизации Google Sheets

## Описание проекта

Этот проект представляет собой AI-агента, разработанного для автоматизации задач в Google Sheets. Агент предназначен для анализа данных, выявления отклонений на основе заданных правил, предложения решений и постепенного выполнения утвержденных действий. Проект разделен на три основные стадии разработки, каждая из которых расширяет функциональность агента.

**Цель проекта**: Создать инструмент, который минимизирует ручной труд при работе с Google Sheets, предоставляя автоматизированные аналитические отчеты, рекомендации и действия на основе данных и транскрипций звонков.

**Язык разработки**: Python с использованием Poetry для управления зависимостями.

**Основные инструменты**:
- Google Sheets API и Google Drive API для работы с таблицами и файлами.
- Google Apps Script для автоматизации внутри таблиц.
- OpenAI API для анализа транскрипций звонков и генерации предложений.
- tl;dv для записи и транскрипции звонков с последующим сохранением в Google Drive.

## Стадии разработки

### Стадия 1: Выявление отклонений и предложение решений

- **Цель**: Сканировать Google Sheets на наличие отклонений (сигналов) на основе предопределенных правил из листа `Algorithm`.
- **Функциональность**:
  - Сканирование данных на листе `Data_Funnel`.
  - Сопоставление данных с правилами из листа `Algorithm`.
  - Запись выявленных сигналов на лист `Signals`.
  - Генерация решений на основе правил и запись их на лист `Decisions`.
  - Подсветка ячеек с отклонениями для визуального выделения.
  - Предоставление интерфейса (sidebar) для утверждения или отклонения решений.
- **Технология**: Google Apps Script для реализации логики внутри Google Sheets.

### Стадия 2: Обновление алгоритмов на основе звонков

- **Цель**: Анализировать транскрипции ежедневных звонков для выявления новых решений, не покрытых существующими правилами.
- **Функциональность**:
  - Чтение транскрипций звонков из Google Drive (интеграция с tl;dv).
  - Использование LLM (например, OpenAI API) для анализа текста и извлечения новых идей или решений.
  - Запись предложений по обновлению правил на лист `Proposals`.
- **Технология**: Python-скрипты для работы с Google Drive API и OpenAI API.

### Стадия 3: Автоматизация действий

- **Цель**: Постепенно взять на себя выполнение утвержденных действий.
- **Функциональность**:
  - Автоматическое выполнение действий, таких как корректировка ставок в рекламе или создание тикетов на контент.
  - Логирование всех действий для аудита.
- **Технология**: Расширение Python-скриптов для выполнения действий через соответствующие API.

## Структура Google Sheets

AI-агент работает с таблицей, которая имеет следующую структуру:

- **Algorithm**: Содержит правила в формате "если...то..." для выявления отклонений и генерации решений.
- **Signals**: Лист для записи выявленных отклонений (сигналов).
- **Decisions**: Лист для записи предложенных решений на основе сигналов.
- **Proposals**: Лист для предложений по обновлению правил на основе анализа звонков.
- **Data_Funnel**: Лист с исходными данными для анализа.

## Требования и настройка

### Требования

- **Python 3.8+** и **Poetry** для управления зависимостями.
- **Google Cloud Project** с включенными API для Sheets и Drive.
- **Service Account** с доступом к Google Sheets и Drive (JSON ключ или переменные окружения).
- **OpenAI API Key** для анализа транскрипций.
- **tl;dv** для записи звонков и сохранения транскрипций в Google Drive.

### Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone <URL репозитория>
   cd AI-agent_with_Cursor
   ```

2. **Установите зависимости**:
   - С использованием Poetry:
     ```bash
     poetry install
     ```
   - Или с использованием pip:
     ```bash
     pip install -r requirements.txt
     ```

3. **Настройте переменные окружения**:
   - Скопируйте `env.example` в `.env`:
     ```bash
     copy env.example .env
     ```
   - Отредактируйте `.env`, указав путь к JSON файлу Service Account или отдельные переменные (`GOOGLE_CLIENT_EMAIL`, `GOOGLE_PRIVATE_KEY`), а также `OPENAI_API_KEY` и ID вашей Google Sheets.

4. **Настройте доступ к Google Sheets**:
   - Убедитесь, что ваш Service Account имеет доступ редактора к целевой Google Sheet.
   - Запустите скрипт настройки:
     ```bash
     poetry run python src/ai_agent/setup/google_setup.py
     ```
     Этот скрипт создаст необходимые листы и заполнит `Algorithm` начальными правилами.

### Интеграция с tl;dv

- Настройте tl;dv для сохранения транскрипций звонков в Google Drive.
- Укажите ID папки Google Drive с транскрипциями в переменной окружения `GOOGLE_DRIVE_CALLS_FOLDER_ID` в файле `.env`.

### Настройка MCP (Model Context Protocol) для Cursor

Для интеграции Cursor с Google Sheets:
1. Установите MCP сервер:
   ```bash
   poetry run pip install mcp-google
   ```
2. Запустите MCP сервер:
   ```bash
   poetry run mcp-google
   ```
3. Следуйте инструкциям в `НАСТРОЙКА-MCP-GOOGLE.md` для завершения настройки.

## Использование

### Стадия 1: Сканирование и решения

- Google Apps Script автоматически сканирует таблицу на наличие отклонений (по расписанию или по запросу через sidebar).
- Вы можете утвердить или отклонить предложенные решения через интерфейс в Google Sheets.

### Стадия 2: Анализ звонков

- Запустите скрипт для анализа транскрипций:
  ```bash
  poetry run python src/ai_agent/jobs/proposals_from_drive.py
  ```
- Скрипт извлечет новые предложения из звонков и запишет их на лист `Proposals`.

### Тестирование соединений

- Для проверки соединения с Google API:
  ```bash
  poetry run python src/ai_agent/setup/test_connections.py
  ```

## Устранение неполадок

- **Проблемы с Google API Credentials**: Убедитесь, что путь к JSON файлу указан правильно в `GOOGLE_APPLICATION_CREDENTIALS` или переменные `GOOGLE_CLIENT_EMAIL` и `GOOGLE_PRIVATE_KEY` настроены в `.env`. См. `ИСПРАВЛЕНИЕ-ПРОБЛЕМ.md`.
- **Проблемы с OpenAI API**: Проверьте, что `OPENAI_API_KEY` указан в `.env`.
- **Терминальные ошибки**: Если команды не выполняются из-за кодировки, используйте `cmd` вместо PowerShell или проверьте настройки терминала.

## Структура проекта

- `src/ai_agent/`: Основной код агента на Python.
  - `config.py`: Конфигурация приложения и переменные окружения.
  - `google/auth.py`: Аутентификация в Google API.
  - `setup/google_setup.py`: Скрипт для настройки структуры Google Sheets.
  - `jobs/proposals_from_drive.py`: Скрипт для анализа транскрипций и генерации предложений.
- `docs/`: Документация проекта.
- `ai-agent-sheets-473515-12c6cb0e6fab.json`: JSON ключ Service Account (если используется).

## Контакты и поддержка

Если у вас есть вопросы или проблемы, обратитесь к документации в папке `docs` или свяжитесь с разработчиком.

## Лицензия

Указать лицензию, если применимо.

---

*Этот README может быть использован как промпт для нейронных сетей или как справочный материал для понимания контекста проекта.*
